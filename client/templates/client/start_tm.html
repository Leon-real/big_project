<!-- start_tm.html -->
{% extends 'base.html' %}

{% load static %}

{% block static %}
    <!-- External CSS file link -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div id="main" class="container">
    <hr>
    <br><br>

    <h3>Outbound TM</h3>
    <a>tm 목적:  {{ input_data }}</a>

    <!-- main -->
    <div id='main' class='containered' style='display: flex; justify-content: space-between; align-items: flex-start;'>
        <div id='chart' style='width: 200px; border: 1px solid #ccc; text-align: center;'>
            <h3 style='font-size: 1rem;'>선택된 고객 목록</h3>
            <table border='1'>
                <thead>
                    <tr>
                        <th><input type='checkbox' id='select-all'></th>
                        <th>이름</th>
                        <th>주소</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in selectedClients %}
                        <tr>
                            <td><input type='checkbox' name='client_ids' value='{{ client.id }}'></td>
                            <td>{{ client.name }}</td>
                            <td>{{ client.location }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3 style='font-size: 1rem;'>선택된 파일 목록</h3>
            <table border='1'>
                <thead>
                    <tr>
                        <th><input type='checkbox' id='select-all2'></th>
                        <th>파일 이름</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in selectedFiles %}
                        <tr>
                            <td><input type='checkbox' name='file_ids' value='{{ file.id }}'></td>
                            <td>{{ file.file.name|cut:"_"|slice:"1:" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button id='goBack' onclick='goBack()'>뒤로가기</button>
        </div>

        <!-- 채팅 대화창 -->
        <div class='chat-container'>
            <div class='user-info'>
                <img src='../../../static/images/냥.jpg' alt='User Avatar' width='30' height='30'>
                {% for client in selectedClients %}
                <span>{{ client.name }}</span>
                <div class='user-status-indicator'></div>
                {% endfor %}
            </div>

            <div class='chat-messages' id='chat-messages'>
                <!-- 채팅 메시지들이 동적으로 추가될 부분 -->
                <div class='message received'>
                    <div class='message-bubble' id='initialMessage'>{{ question.0 }}</div>
                </div>
            </div>
            <div class='input-container'>
                <input type='text' id='message-input' placeholder='Type your message...'>
                <button class='send-button' onclick='sendMessage()'>Send</button>
            </div>
        </div>

        

        {% comment %}
        <div>
            <audio controls>녹음된 소리를 재생할 audio 엘리먼트</audio>
            <br><br><br><br><br>
            <div class="button-container">
                <!-- 시작할 때 드러날 버튼들 -->
                <button id="recordbutton" onclick="showButton('startrecord');" style="background-image: url('{% static 'loading_recording/icons8-recording-60.png' %}');" class="button-image"></button>
                <button id="playbutton" onclick="playAudio(); showButton('playvoice');" style="background-image: url('{% static 'loading_recording/icon8-play-60.png' %}');" class="button-image"></button>
                <!-- 시작할 때 숨어있을 이미지, 버튼들 -->
                <button id="no_record" style="display: none; background-image: url('{% static 'loading_recording/icons8-no-record-60.gif' %}');" class="button-image"></button>
                <button id="stop_record" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-voice-recognition-60.gif' %}');" class="button-image"></button>
                <button id="no_play" style="display: none; background-image: url('{% static 'loading_recording/icons8-hearing-60.png' %}');" class="button-image"></button>
                <button id="playing" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-speech-bubble-60.gif' %}');" class="button-image"></button>
            </div>
            </div>
        </div>
        {% endcomment %}


        {% comment %} <div>
            <audio controls>녹음된 소리를 재생할 audio 엘리먼트</audio>
                    <br><br><br><br><br>
                    <div class="button-container">
                        <!-- 시작할 때 드러날 버튼들 -->
                        <button id="recordbutton" onclick="showButton('startrecord');" style="background-image: url('{% static 'loading_recording/icons8-recording-60.png' %}');" class="button-image"></button>
                        <button id="playbutton" onclick="playAudio(); showButton('playvoice');" style="background-image: url('{% static 'loading_recording/icon8-play-60.png' %}');" class="button-image"></button>
                        <!-- 시작할 때 숨어있을 이미지, 버튼들 -->
                        <button id="no_record" style="display: none; background-image: url('{% static 'loading_recording/icons8-no-record-60.gif' %}');" class="button-image"></button>
                        <button id="stop_record" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-voice-recognition-60.gif' %}');" class="button-image"></button>
                        <button id="no_play" style="display: none; background-image: url('{% static 'loading_recording/icons8-hearing-60.png' %}');" class="button-image"></button>
                        <button id="playing" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-speech-bubble-60.gif' %}');" class="button-image"></button>
                    </div>
                </div>
        </div> {% endcomment %}


        {% comment %} 
        <div>
            <audio controls>녹음된 소리를 재생할 audio 엘리먼트</audio>
            <br><br><br><br><br>
            <div class="button-container">
                <!-- 시작할 때 드러날 버튼들 -->
                <button id="recordbutton" onclick="showButton('startrecord');" style="background-image: url('{% static 'loading_recording/icons8-recording-60.png' %}');" class="button-image"></button>
                <button id="playbutton" onclick="playAudio(); showButton('playvoice');" style="background-image: url('{% static 'loading_recording/icon8-play-60.png' %}');" class="button-image"></button>
                <!-- 시작할 때 숨어있을 이미지, 버튼들 -->
                <button id="no_record" style="display: none; background-image: url('{% static 'loading_recording/icons8-no-record-60.gif' %}');" class="button-image"></button>
                <button id="stop_record" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-voice-recognition-60.gif' %}');" class="button-image"></button>
                <button id="no_play" style="display: none; background-image: url('{% static 'loading_recording/icons8-hearing-60.png' %}');" class="button-image"></button>
                <button id="playing" onclick="showButton('stoprecord');" style="display: none; background-image: url('{% static 'loading_recording/icons8-speech-bubble-60.gif' %}');" class="button-image"></button>
            </div>
        </div>
        {% endcomment %}

    </div>
</div>

<script>
    function goBack() {
        window.history.back();
    }

    const chatInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const initialMessage = document.getElementById('initialMessage');
    const questions = [{% for q in question %}'{{ q }}', {% endfor %}];
    const chatbots_ids = [{% for q in chatbots_ids %}'{{ q }}', {% endfor %}];
    console.log(chatbots_ids[0]);


    let currentQuestionIndex = 1;  // 0번째 질문은 이미 보여주었으므로 1부터 시작
    let exitConversation = false; // 대화 중단 원할시 True, 대화 계속 하길 원할시 False
    let finalConversation = false; // 대화가 종료 되었을 경우 True, 대화가 끝나지 않을 경우 false

    // 기존 코드
    async function sendMessage() {
        const userMessage = chatInput.value.trim();

        if (userMessage !== '') {
            // 사용자의 입력을 채팅창에 동적으로 추가
            const userChatMessage = document.createElement('div');
            userChatMessage.className = 'message sent';
            userChatMessage.innerHTML = `<div class="message-bubble">${userMessage}</div>`;
            chatMessages.appendChild(userChatMessage);


            // ajax, fetch 사용해야 할 부분
            console.log(userMessage);
            let results = await executeBackendTextProcessing(userMessage);
            console.log("@@@");
            console.log(results);

            if (exitConversation===false){
                // 대화를 계속 원하는 경우 (exitConversation False)
                if (results === '부정') {
                    const neMessage = document.createElement('div');
                    neMessage.className = 'message received';
                    neMessage.innerHTML = `<div class="message-bubble">혹시 대화를 종료하기를 원하시나요?</div>`;
                    chatMessages.appendChild(neMessage);
                    exitConversation = true;
                } else {
                    // 긍정 혹은 중립일 경우 실행되는 부분
                    if (currentQuestionIndex < questions.length) {
                        const neMessage = document.createElement('div');
                        neMessage.className = 'message received';
                        neMessage.innerHTML = `<div class="message-bubble">${questions[currentQuestionIndex]}</div>`;
                        chatMessages.appendChild(neMessage);
                        currentQuestionIndex += 1;
                    } else {
                        // 모든 질문에 대한 응답이 끝났을 경우 채팅 종료
                        const endMessage = document.createElement('div');
                        endMessage.className = 'message received';
                        endMessage.innerHTML = '<div class="message-bubble">채팅이 종료되었습니다.</div>';
                        chatMessages.appendChild(endMessage);
                        finalConversation=true;
                        // 추가로 필요한 동작 수행 (채팅 종료 등)
                    }
                }

            } else {
                // 대화가 중단되는 것을 물어보는 단계( exitConversation가 True)
                const neMessage = document.createElement('div');
                if (results === '긍정') {
                    const neMessage = document.createElement('div');
                    neMessage.className = 'message received';
                    neMessage.innerHTML = `<div class="message-bubble">감사합니다. 문의 사항 있다면 연락주세요. 02-XXXX-XXXX</div>`;
                    chatMessages.appendChild(neMessage);
                    exitConversation = true;
                    finalConversation=true;
                } else {
                    exitConversation = false;
                    // 긍정 혹은 중립일 경우 실행되는 부분
                    if (currentQuestionIndex < questions.length) {
                        const neMessage = document.createElement('div');
                        neMessage.className = 'message received';
                        neMessage.innerHTML = `<div class="message-bubble">${questions[currentQuestionIndex]}</div>`;
                        chatMessages.appendChild(neMessage);
                        currentQuestionIndex += 1;
                    } else {
                        // 모든 질문에 대한 응답이 끝났을 경우 채팅 종료
                        const endMessage = document.createElement('div');
                        endMessage.className = 'message received';
                        endMessage.innerHTML = '<div class="message-bubble">채팅이 종료되었습니다.</div>';
                        chatMessages.appendChild(endMessage);
                        // 추가로 필요한 동작 수행 (채팅 종료 등)
                    }
                }
            }




            /*// '네'에 대한 응답을 자동으로 추가
            if (results === '부정') {
                const neMessage = document.createElement('div');
                neMessage.className = 'message received';
                neMessage.innerHTML = `<div class="message-bubble">혹시 대화를 종료하기를 원하시나요?</div>`;
                chatMessages.appendChild(neMessage);
                exitConversation = True;
            } else {
                // 긍정 혹은 중립일 경우 실행되는 부분
                if (currentQuestionIndex < questions.length) {
                    const neMessage = document.createElement('div');
                    neMessage.className = 'message received';
                    neMessage.innerHTML = `<div class="message-bubble">${questions[currentQuestionIndex]}</div>`;
                    chatMessages.appendChild(neMessage);
                    currentQuestionIndex += 1;
                } else {
                    // 모든 질문에 대한 응답이 끝났을 경우 채팅 종료
                    const endMessage = document.createElement('div');
                    endMessage.className = 'message received';
                    endMessage.innerHTML = '<div class="message-bubble">채팅이 종료되었습니다.</div>';
                    chatMessages.appendChild(endMessage);
                    // 추가로 필요한 동작 수행 (채팅 종료 등)
                }
            }*/





            // 입력창 초기화 및 포커스 유지
            chatInput.value = '';
            chatInput.focus();
        }


        // 대화 질문 끝까지 안내 나갔을 경우
        if (questions.length === currentQuestionIndex){
            finalConversation = true;
        }
        // 대화가 끝났을 경우 채팅 내용 백앤드에 저장되게 실행
        if (finalConversation===true){
            // chat-messages 요소 안에 있는 모든 message 요소를 선택
            let messageElements = document.querySelectorAll('.chat-messages .message');
            // 결과를 저장할 배열 선언
            let all_messages = [];
            // 각 message 요소에 대해 반복
            messageElements.forEach(function(messageElement) {
                // 각 message 요소 안에 있는 message-bubble 요소 선택
                var messageBubble = messageElement.querySelector('.message-bubble');

                // message-bubble 요소가 존재하는 경우 텍스트를 가져와서 배열에 추가
                if (messageBubble) {
                    var text = messageBubble.textContent.trim();
                    all_messages.push(text);
                }
            });

            // 결과 확인
            console.log(all_messages);
            console.log()
            // 데이터 백앤드로 전송하기
            let send_message_results = await save_all_messages(all_messages);
            console.log(send_message_results);
            
        }
        
    }

    // 모든 채팅 데이터 백앤드로 전달하기
    async function save_all_messages(AllMessages) {
        try {
            const response = await fetch('/client/start_tm/message_results/', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    //'X-CSRFToken': csrf_token,  // Django에서 사용하는 CSRF 토큰을 포함시켜야 함
                },
                body: JSON.stringify({
                    'all_messages': all_messages,
                    'chatbots_ids': chatbots_ids[0],
                }),
            });
            const data = await response.json();
    
            return data.result;  // 예시로 결과 값 반환
        } catch (error) {
            console.error("채팅 저장하는 부분(save_all_messages) 에러 발생:", error);
            throw error;  // 에러를 다시 던지면 이후에도 에러 처리 가능
        }
    }


    // 텍스트 백앤드 전달하여 감정 분류 및 결과 값 받기
    async function executeBackendTextProcessing(userMessage) {
        try {
            const response = await fetch("/client/start_tm/text_processing/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ userMessage: userMessage }),
            });
    
            const data = await response.json();
    
            // 여기에서 필요한 동작 수행
    
            return data.result;  // 예시로 결과 값 반환
        } catch (error) {
            console.error("에러 발생:", error);
            throw error;  // 에러를 다시 던지면 이후에도 에러 처리 가능
        }
    }








    // 엔터 키를 누를 때 sendMessage 호출
    chatInput.addEventListener('keyup', function (event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    {% comment %}
    function showButton(val) {

            
    /*function showButton(val) {
        var startrecordButton = document.getElementById('recordbutton');
        var playButton = document.getElementById('playbutton');
        var cantrecordimg = document.getElementById('no_record');
        var stoprecordButton = document.getElementById('stop_record');
        var cantplayimg = document.getElementById('no_play');
        var playingimg = document.getElementById('playing');
       
   
        if (val === 'startrecord') {
            startrecordButton.style.display = 'none';
            playButton.style.display = 'none';
            cantrecordimg.style.display = 'none';
            stoprecordButton.style.display = 'block';
            playingimg.style.display = 'none';
            cantplayimg.style.display = 'block';
        } else if (val === 'stoprecord') {
            startrecordButton.style.display = 'block';
            playButton.style.display = 'block';
            cantrecordimg.style.display = 'none';
            stoprecordButton.style.display = 'none';
            playingimg.style.display = 'none';
            cantplayimg.style.display = 'none';
        } else if (val === 'playvoice') {
            startrecordButton.style.display = 'none';
            playButton.style.display = 'none';
            cantrecordimg.style.display = 'block';
            stoprecordButton.style.display = 'none';
            playingimg.style.display = 'block';
            cantplayimg.style.display = 'none';
        }
    }

    // 엘리먼트 취득
    const $audioEl = document.querySelector("audio");
    const $startRecordBtn = document.getElementById("recordbutton");
    const $stopRecordBtn = document.getElementById("stop_record");

    // 녹음중 상태 변수
    let isRecording = false;

    // MediaRecorder 변수 생성
    let mediaRecorder = null;

    // 녹음 데이터 저장 배열
    const audioArray = [];

    // 버튼 기능 설정
    document.addEventListener("DOMContentLoaded", function () {
        // 초기에 알파 버튼만 보이게 설정
        showButton('recordbutton');
        showButton('playbutton');

        // 시작 버튼에 클릭 이벤트 추가
        $startRecordBtn.addEventListener('click', function () {
            if (!isRecording) {
                // 마이크 mediaStream 생성: Promise를 반환하므로 async/await 사용
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(async (mediaStream) => {
                        // MediaRecorder 생성
                        mediaRecorder = new MediaRecorder(mediaStream);

                        // 이벤트핸들러: 녹음 데이터 취득 처리
                        mediaRecorder.ondataavailable = (event) => {
                            console.log('Received audio data:', event.data);
                            audioArray.push(event.data);
                        }

                        // 이벤트핸들러: 녹음 종료 처리 & 재생하기
                        mediaRecorder.onstop = async (event) => {
                            const blob = new Blob(audioArray, { type: "audio/ogg; codecs=opus" });
                            audioArray.splice(0);
                            const formData = new FormData();
                            formData.append('audio_data', blob);
                            const response = await fetch('/client/save_audio/', {
                                method: 'POST',
                                body: formData,
                                credentials: 'include',
                            });
                            const responseData = await response.json();
                            console.log(responseData.message);

                            const blobURL = window.URL.createObjectURL(blob);
                            $audioEl.src = blobURL;
                            $audioEl.play();
                            showButton('stoprecord');
                        };

                        // 녹음 시작
                        mediaRecorder.start();
                        isRecording = true;
                        showButton('startrecord');
                    })
                    .catch((error) => {
                        console.error('Error accessing microphone:', error);
                    });
            }
        });

        // 종료 버튼에 클릭 이벤트 추가
        $stopRecordBtn.addEventListener('click', function () {
            if (isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
        });
    });


    // 재생 버튼 클릭 시 오디오 재생
    function playAudio() {
        if ($audioEl.src) {
            $audioEl.play();
        }
    }
    {% endcomment %}

</script>

{% endblock %}
